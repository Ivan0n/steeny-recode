<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MusicStream ‚Äî Steeny</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { font-family: 'Inter', sans-serif; overflow: hidden;}
    .menu-link { @apply flex items-center gap-3 px-4 py-2 rounded-lg transition cursor-pointer font-medium; background: #f3f4f6; }
    .menu-link:hover { background: #e5e7eb; transform: translateY(-1px); }
    .menu-link.active { background: #111827; color: #ffffff; }
    footer.player { background: #ffffff; color: #111827; border-top: 1px solid #e5e7eb; }
    .seekbar { -webkit-appearance: none; width: 100%; height: 6px; background: linear-gradient(90deg,#111827 0%, #d1d5db 0%); border-radius: 4px; outline: none; cursor: pointer; }
    .seekbar::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #111827; box-shadow: 0 0 0 4px rgba(17,24,39,0.06); cursor: pointer; }
    .volume-slider { -webkit-appearance: none; width: 160px; height: 6px; background: linear-gradient(90deg,#111827 100%, #e6e6e6 100%); border-radius: 4px; outline: none; cursor: pointer; }
    .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #111827; box-shadow: 0 0 0 3px rgba(17,24,39,0.06); cursor: pointer; }
    .player-btn { width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; background: #f3f4f6; border: 1px solid #e6e6e6; transition: background .15s, transform .08s; cursor: pointer; }
    .player-btn:hover { background: #e5e7eb; transform: translateY(-2px); }
    .player-btn.play { width: 56px; height: 56px; }
    .player-btn i { font-size: 18px; color: #111827; }
    .controls-center { min-width: 320px; display:flex; gap:18px; align-items:center; justify-content:center; }
    .track-item { transition: background .12s, transform .08s; }
    .track-item:hover { background: #f8fafc; transform: translateY(-1px); }
    .left-meta { min-width: 260px; max-width: 320px; display:flex; gap:12px; align-items:center; }
    .right-volume { min-width: 220px; display:flex; gap:12px; align-items:center; justify-content:flex-end; }
    @media (max-width:900px){ .controls-center { min-width: 0; gap:10px; } .volume-slider { width: 110px; } .left-meta { min-width: 160px; } footer.player { padding-left: 12px; padding-right: 12px; } }

    .search_iframe { width: 100%; height: 80vh; border: none; border-radius: 12px; }
    .track-list {
        display: flex;
        flex-direction: column;
        gap: 1px;
        max-height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        background: #f8fafc;
    }

    .track-row {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        transition: all 0.2s ease;
        min-width: 0;
    }

    .track-row:hover {
        background: #f1f5f9;
        transform: translateX(2px);
    }

    .track-row.active {
        background: #eff6ff;
        border-left: 3px solid #000000;
    }

    .track-info {
        flex: 1;
        min-width: 0;
        margin-right: 12px;
    }

    .track-title {
        font-weight: 600;
        font-size: 14px;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-artist {
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    .track-number {
        width: 20px;
        font-size: 12px;
        color: #9ca3af;
        text-align: center;
        flex-shrink: 0;
    }

    .track-duration {
        font-size: 12px;
        color: #9ca3af;
        width: 40px;
        text-align: right;
        flex-shrink: 0;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    .track-list::-webkit-scrollbar {
        width: 6px;
    }

    .track-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .track-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .track-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
  </style>
</head>
<body class="bg-white text-black flex flex-col min-h-screen text-[15px]">
  <div class="flex flex-1">
    <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é -->
    <aside class="w-60 bg-white text-black border-r border-gray-200 flex flex-col justify-between">
      <div>
        <div class="flex items-center gap-3 p-5 border-b border-gray-200">
          <div class="w-10 h-10 bg-black text-white rounded flex items-center justify-center font-bold text-lg">
            <img src="https://i.pinimg.com/736x/5a/d6/ef/5ad6ef496c7a7c342b9b0fdf2bce426a.jpg" alt="" style="border-radius: 8px; width:100%; height:100%; object-fit:cover;">
          </div>
          <span class="font-bold text-lg">Steeny</span>
        </div>
        <nav id="menu" class="mt-6 flex flex-col gap-3 px-3 text-base">
          <div class="menu-link active" data-section="home"><i class="fa-solid fa-house"></i> –ì–ª–∞–≤–Ω–∞—è</div>
          <div class="menu-link" data-section="search"><i class="fa-solid fa-magnifying-glass"></i> –ü–æ–∏—Å–∫</div>
          <div class="menu-link" data-section="favorites"><i class="fa-solid fa-heart"></i> –õ—é–±–∏–º–æ–µ</div>
        </nav>
      </div>
      <div class="px-3 py-6 border-t border-gray-200 flex flex-col gap-2 text-base font-medium">
        <div class="menu-link"><i class="fa-solid fa-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="menu-link"><i class="fa-solid fa-right-from-bracket"></i> <a href="/logout">–í—ã–π—Ç–∏</a></div>
      </div>
    </aside>

    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="flex-1 flex flex-col">
      <header class="flex justify-end items-center p-5 border-b border-gray-200">
        <span class="mr-4 font-semibold">{{ name }}</span>
        <img src="{{ avatar }}" class="w-10 h-10 rounded-full" alt="avatar">
      </header>

      <div id="content" class="flex-1 overflow-y-auto p-8">
        <!-- –ì–ª–∞–≤–Ω–∞—è -->
<!-- –ì–ª–∞–≤–Ω–∞—è -->
<!-- –ì–ª–∞–≤–Ω–∞—è -->
      <div id="section-home">
          <h2 class="text-2xl font-bold mb-4">üéµ –í—Å—è –º—É–∑—ã–∫–∞</h2>
          <div class="bg-white rounded-lg border border-gray-200 p-4">
              <div class="flex items-center justify-between mb-4" >
                  <h3 class="font-semibold text-gray-700" >–í—Å–µ —Ç—Ä–µ–∫–∏ ({{total_tracks}})</h3>
                  <div class="flex items-center gap-2">
                      <input type="text" placeholder="–§–∏–ª—å—Ç—Ä..." 
                            class="px-3 py-1 border border-gray-300 rounded text-sm" 
                            oninput="filterTracks(this.value)">
                      <button class="p-1 text-gray-500 hover:text-gray-700">
                          <i class="fa-solid fa-arrow-down-wide-short" ></i>
                      </button>
                  </div>
              </div>
              <div class="track-list" id="allTracksList" style="height: 350px; overflow-x: hidden;">
                  <!-- –¢—Ä–µ–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
              </div>
          </div>
      </div>

        <!-- –ü–æ–∏—Å–∫ -->
<!-- –ü–æ–∏—Å–∫ -->
          <!-- –ü–æ–∏—Å–∫ -->
          <div id="section-search" class="hidden">
              <h2 class="text-2xl font-bold mb-4">üîç –ü–æ–∏—Å–∫</h2>
              <div class="flex gap-2 mb-4">
                  <input id="searchInput" type="text" placeholder="–ò—Å–∫–∞—Ç—å —Ç—Ä–µ–∫ –∏–ª–∏ –∞—Ä—Ç–∏—Å—Ç–∞..." 
                        class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                  <button onclick="searchMusic()" 
                          class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800">–ò—Å–∫–∞—Ç—å</button>
              </div>
              <div class="bg-white rounded-lg border border-gray-200 p-4">
                  <div id="searchResults" class="track-list" style="height: 320px; overflow-x: hidden;">
                      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                       
                  </div>
              </div>
          </div>


        <!-- –õ—é–±–∏–º–æ–µ -->
        <div id="section-favorites" class="hidden">
            <h2 class="text-2xl font-bold mb-4">‚ù§Ô∏è –õ—é–±–∏–º—ã–µ —Ç—Ä–µ–∫–∏</h2>
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-700">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ ({{favorite_count}})</h3>
                </div>
                <div class="track-list" id="favoritesList" style="height: 350px; overflow-x: hidden;">
                    <!-- –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </main>
  </div>

  <!-- ---- –ü–ª–µ–µ—Ä ---- -->
  <footer class="player border-t p-4">
    <div class="mb-4">
      <input type="range" id="seekbar" class="seekbar mb-1" value="0" max="100">
      <div class="flex justify-between w-full text-xs text-gray-500">
        <span id="currentTime">0:00</span>
        <span id="duration">0:00</span>
      </div>
    </div>

    <div class="flex items-center justify-between">
      <div class="left-meta">
        <img id="coverImg" src="https://via.placeholder.com/64" class="w-14 h-14 rounded" alt="cover">
        <div>
          <div id="trackTitle" class="font-semibold text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</div>
          <div id="trackArtist" class="text-xs text-gray-500">–ê—Ä—Ç–∏—Å—Ç</div>
        </div>
        <button id="favBtn" class="ml-3 text-2xl text-gray-400 hover:text-yellow-500"><i class="fa-solid fa-star"></i></button>
      </div>

      <div class="controls-center">
        <button id="prevBtn" class="player-btn"><i class="fa-solid fa-backward-step"></i></button>
        <button id="playBtn" class="player-btn play"><i id="playIcon" class="fa-solid fa-play"></i></button>
        <button id="nextBtn" class="player-btn"><i class="fa-solid fa-forward-step"></i></button>
        <button id="repeatBtn" class="player-btn"><i id="repeatIcon" class="fa-solid fa-repeat"></i></button>
      </div>

      <div class="right-volume">
        <i id="volumeIcon" class="fa-solid fa-volume-high"></i>
        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="1">
      </div>
    </div>

    <audio id="audioPlayer"></audio>
  </footer>

<script>
    const audio = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const seekbar = document.getElementById('seekbar');
    const currentTimeElem = document.getElementById('currentTime');
    const durationElem = document.getElementById('duration');
    const repeatBtn = document.getElementById('repeatBtn');
    const repeatIcon = document.getElementById('repeatIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeIcon = document.getElementById('volumeIcon');
    const titleElem = document.getElementById('trackTitle');
    const artistElem = document.getElementById('trackArtist');
    const coverImg = document.getElementById('coverImg');
    const favoritesList = document.getElementById('favoritesList');
    const favBtn = document.getElementById('favBtn');

    let allTracks = []; // –í—Å–µ —Ç—Ä–µ–∫–∏ –∏–∑ –±–∞–∑—ã
    let currentPlaylist = []; // –¢–µ–∫—É—â–∏–π –ø–ª–µ–π–ª–∏—Å—Ç –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    let isPlaying = false, isRepeating = false, currentTrackIndex = 0;
    let currentSection = 'home'; // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–¥–µ–ª

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤
    async function loadAllTracks() {
        const res = await fetch("/playlist/data");
        const data = await res.json();
        if (!data.error) {
            allTracks = data;
            currentPlaylist = [...allTracks]; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
            renderAllTracks();
            renderFavorites();
            if (currentPlaylist.length > 0) {
                loadTrack(currentTrackIndex);
            }
        }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤
    function renderAllTracks() {
        const container = document.getElementById('allTracksList');
        if (!container) return;
        
        container.innerHTML = '';
        
        allTracks.forEach((track, index) => {
            const row = document.createElement('div');
            row.className = 'track-row';
            if (currentSection === 'home' && index === currentTrackIndex && currentPlaylist === allTracks) {
                row.classList.add('active');
            }
            row.innerHTML = `
                <div class="track-number">${index + 1}</div>
                <div class="track-info">
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist}</div>
                </div>
                <div class="track-duration">2:45</div>
                <div class="track-actions">
                    <button class="text-gray-400 hover:text-yellow-500">
                        <i class="fa-solid ${track.favorite ? 'fa-star text-yellow-500' : 'fa-star'}"></i>
                    </button>
                    <button class="text-gray-400 hover:text-blue-500">
                        <i class="fa-solid fa-play"></i>
                    </button>
                </div>
            `;
            
            row.querySelector('button:first-child').onclick = (e) => {
                e.stopPropagation();
                toggleFavoriteForTrack(track, index);
            };
            
            row.querySelector('button:last-child').onclick = (e) => {
                e.stopPropagation();
                playFromSection('home', index);
            };
            
            row.onclick = () => {
                playFromSection('home', index);
            };
            
            container.appendChild(row);
        });
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
    function renderFavorites() {
        const container = document.getElementById('favoritesList');
        if (!container) return;
        
        container.innerHTML = '';
        
        const favoriteTracks = allTracks.filter(track => track.favorite);
        let favoriteCount = 0;
        
        favoriteTracks.forEach((track, index) => {
            favoriteCount++;
            
            const row = document.createElement('div');
            row.className = 'track-row';
            if (currentSection === 'favorites' && index === currentTrackIndex && currentPlaylist === favoriteTracks) {
                row.classList.add('active');
            }
            row.innerHTML = `
                <div class="track-number">${favoriteCount}</div>
                <div class="track-info">
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist}</div>
                </div>
                <div class="track-duration">2:45</div>
                <div class="track-actions">
                    <button class="text-yellow-500 hover:text-gray-400">
                        <i class="fa-solid fa-star"></i>
                    </button>
                    <button class="text-gray-400 hover:text-blue-500">
                        <i class="fa-solid fa-play"></i>
                    </button>
                </div>
            `;
            
            row.querySelector('button:first-child').onclick = (e) => {
                e.stopPropagation();
                const originalIndex = allTracks.findIndex(t => t.id === track.id);
                toggleFavoriteForTrack(track, originalIndex);
            };
            
            row.querySelector('button:last-child').onclick = (e) => {
                e.stopPropagation();
                playFromSection('favorites', index);
            };
            
            row.onclick = () => {
                playFromSection('favorites', index);
            };
            
            container.appendChild(row);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        const favoriteHeader = document.querySelector('#section-favorites h3');
        if (favoriteHeader) {
            favoriteHeader.textContent = `–ò–∑–±—Ä–∞–Ω–Ω–æ–µ (${favoriteCount})`;
        }
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
    function playFromSection(section, index) {
        currentSection = section;
        
        switch(section) {
            case 'home':
                currentPlaylist = [...allTracks];
                break;
            case 'favorites':
                currentPlaylist = allTracks.filter(track => track.favorite);
                break;
            case 'search':
                // –î–ª—è –ø–æ–∏—Å–∫–∞ currentPlaylist —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ searchMusic
                break;
        }
        
        currentTrackIndex = index;
        loadTrack(currentTrackIndex);
        playTrack();
        updateActiveRows();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–∞
    function loadTrack(index) {
        const track = currentPlaylist[index];
        if (!track) return;
        
        titleElem.textContent = track.title;
        artistElem.textContent = track.artist;
        coverImg.src = track.cover;
        audio.src = track.src;
        updateFavBtn(track.favorite);
        isPlaying = false;
        updatePlayIcon(false);
        seekbar.value = 0;
        currentTimeElem.textContent = '0:00';
        durationElem.textContent = '0:00';
        
        updateActiveRows();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–æ–∫
    function updateActiveRows() {
        document.querySelectorAll('.track-row').forEach(row => {
            row.classList.remove('active');
        });
        
        // –ù–∞—Ö–æ–¥–∏–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –≤ —Ç–µ–∫—É—â–µ–º —Ä–∞–∑–¥–µ–ª–µ
        const currentTrack = currentPlaylist[currentTrackIndex];
        if (!currentTrack) return;
        
        switch(currentSection) {
            case 'home':
                const homeIndex = allTracks.findIndex(t => t.id === currentTrack.id);
                if (homeIndex !== -1) {
                    const homeRow = document.querySelectorAll('#allTracksList .track-row')[homeIndex];
                    if (homeRow) homeRow.classList.add('active');
                }
                break;
                
            case 'favorites':
                const favoriteTracks = allTracks.filter(t => t.favorite);
                const favIndex = favoriteTracks.findIndex(t => t.id === currentTrack.id);
                if (favIndex !== -1) {
                    const favRow = document.querySelectorAll('#favoritesList .track-row')[favIndex];
                    if (favRow) favRow.classList.add('active');
                }
                break;
                
            case 'search':
                // –î–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ searchMusic
                break;
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
    async function toggleFavoriteForTrack(track, index) {
        if (track.favorite) {
            await fetch("/playlist/remove", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({id: track.id})
            });
            track.favorite = false;
        } else {
            await fetch("/playlist/add", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({id: track.id})
            });
            track.favorite = true;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateFavBtn(track.favorite);
        renderFavorites();
        renderAllTracks();
        
        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ - —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
        if (currentPlaylist[currentTrackIndex] && currentPlaylist[currentTrackIndex].id === track.id) {
            updateFavBtn(track.favorite);
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
    async function toggleFavorite() {
        const track = currentPlaylist[currentTrackIndex];
        if (!track) return;
        
        await toggleFavoriteForTrack(track, currentTrackIndex);
    }

    // –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏
    async function searchMusic() {
        const q = document.getElementById("searchInput").value;
        const res = await fetch("/search?query=" + encodeURIComponent(q));
        const searchResultsData = await res.json();

        const searchResults = document.getElementById("searchResults");
        searchResults.innerHTML = "";

        if (searchResultsData.length === 0) {
            searchResults.innerHTML = "<p class='p-4 text-gray-500 text-center'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ...</p>";
            return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∫–∞–∫ —Ç–µ–∫—É—â–∏–π –ø–ª–µ–π–ª–∏—Å—Ç
        currentPlaylist = searchResultsData.map(track => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç—Ä–µ–∫ —É–∂–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º
            const existingTrack = allTracks.find(t => t.id === track.id);
            return {
                ...track,
                favorite: existingTrack ? existingTrack.favorite : false
            };
        });

        searchResultsData.forEach((track, index) => {
            const row = document.createElement('div');
            row.className = 'track-row';
            row.innerHTML = `
                <div class="track-number">${index + 1}</div>
                <div class="track-info">
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist}</div>
                </div>
                <div class="track-duration">2:45</div>
                <div class="track-actions">
                    <button class="text-gray-400 hover:text-yellow-500">
                        <i class="fa-solid ${track.favorite ? 'fa-star text-yellow-500' : 'fa-star'}"></i>
                    </button>
                    <button class="text-gray-400 hover:text-blue-500">
                        <i class="fa-solid fa-play"></i>
                    </button>
                </div>
            `;

            row.querySelector('button:first-child').onclick = (e) => {
                e.stopPropagation();
                toggleFavoriteForTrack(track, index);
            };

            row.querySelector('button:last-child').onclick = (e) => {
                e.stopPropagation();
                currentSection = 'search';
                currentTrackIndex = index;
                loadTrack(currentTrackIndex);
                playTrack();
            };

            row.onclick = () => {
                currentSection = 'search';
                currentTrackIndex = index;
                loadTrack(currentTrackIndex);
                playTrack();
            };

            searchResults.appendChild(row);
        });
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ç—Ä–µ–∫—É —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
    function playNextTrack() {
        if (currentPlaylist.length === 0) return;
        
        currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
        
        // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π
        if (currentSection === 'favorites' && currentTrackIndex === 0 && currentPlaylist.length > 0) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –ø–ª–µ–π–ª–∏—Å—Ç—É
            // currentSection = 'home';
            // currentPlaylist = [...allTracks];
            // currentTrackIndex = 0;
        }
        
        loadTrack(currentTrackIndex);
        playTrack();
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–µ–µ—Ä–æ–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function updateFavBtn(fav) {
        favBtn.style.color = fav ? "gold" : "gray";
    }

    function playTrack() {
        audio.play().then(() => {
            isPlaying = true;
            updatePlayIcon(true);
        }).catch(() => {
            isPlaying = false;
            updatePlayIcon(false);
        });
    }

    function pauseTrack() {
        audio.pause();
        isPlaying = false;
        updatePlayIcon(false);
    }

    function updatePlayIcon(playing) {
        playIcon.classList.toggle('fa-play', !playing);
        playIcon.classList.toggle('fa-pause', playing);
    }

    function formatTime(sec) {
        if (!isFinite(sec)) return '0:00';
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return m + ":" + (s < 10 ? "0" : "") + s;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        favBtn.onclick = toggleFavorite;
        playBtn.onclick = () => { isPlaying ? pauseTrack() : playTrack(); };
        prevBtn.onclick = () => { 
            currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
            loadTrack(currentTrackIndex);
            playTrack();
        };
        nextBtn.onclick = () => { 
            playNextTrack();
        };
        repeatBtn.onclick = () => { 
            isRepeating = !isRepeating;
            audio.loop = isRepeating;
            repeatIcon.style.color = isRepeating ? '#111827' : '#6b7280';
        };
        
        seekbar.addEventListener('input', () => {
            if (audio.duration) audio.currentTime = (seekbar.value / 100) * audio.duration;
        });
        
        audio.addEventListener('loadedmetadata', () => {
            durationElem.textContent = formatTime(audio.duration);
        });
        
        audio.onended = () => {
            if (!isRepeating) {
                playNextTrack();
            }
        };
        
        volumeSlider.oninput = () => {
            audio.volume = volumeSlider.value;
            updateVolumeUI(audio.volume);
        };
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é
        document.querySelectorAll(".menu-link").forEach(l => l.onclick = () => {
            document.querySelectorAll(".menu-link").forEach(x => x.classList.remove("active"));
            l.classList.add("active");
            document.querySelectorAll("#content > div").forEach(d => d.classList.add("hidden"));
            document.getElementById(`section-${l.dataset.section}`).classList.remove("hidden");
            currentSection = l.dataset.section;
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        function updateVolumeUI(v) {
            const p = v * 100;
            volumeSlider.style.background = `linear-gradient(90deg,#111827 ${p}%, #e6e6e6 ${p}%)`;
            if (v === 0) volumeIcon.className = "fa-solid fa-volume-xmark";
            else if (v < 0.5) volumeIcon.className = "fa-solid fa-volume-low";
            else volumeIcon.className = "fa-solid fa-volume-high";
        }
        
        audio.volume = volumeSlider.value;
        updateVolumeUI(audio.volume);
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤
        requestAnimationFrame(updateProgress);
        loadAllTracks();
    });

    function updateProgress() {
        if (audio.duration) {
            const p = (audio.currentTime / audio.duration) * 100;
            seekbar.value = p;
            seekbar.style.background = `linear-gradient(90deg,#111827 ${p}%, #e6e6e6 ${p}%)`;
            currentTimeElem.textContent = formatTime(audio.currentTime);
        }
        requestAnimationFrame(updateProgress);
    }
</script>
  
</body>
</html>
